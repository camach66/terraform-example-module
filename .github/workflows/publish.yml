name: Publish module to artifactory

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  ARTIFACTORY_REPO: "https://cloudposse.jfrog.io/artifactory/tfmodules"
  MODULE_NAMESPACE: "vanguard"
  MODULE_NAME: "terraform-example-module"
  PROVIDER_NAME: "example"
  VERSION: ${{ github.sha }}

jobs:
  publish-terraform-module:
    name: publish terraform module to artifactory
    runs-on: ubuntu-latest
    steps:
      - name: download zipfile of current sha
        run: |
          curl -L -o ${{ github.sha }}.zip https://github.com/${GITHUB_REPOSITORY#*/}/archive/${{ github.sha }}.zip
      - name: upload to artifactory
        run: |
          curl -u${{ secrets.JFROG_USER_NAME}}:${{ secrets.JFROG_TOKEN}} -XPUT "${{ env.ARTIFACTORY_REPO}}/${{ env.MODULE_NAMESPACCE}}/${{ env.MODULE_NAME}}/${{ env.PROVIDER_NAME}}/${{ env.VERSION}}.zip" -T ${{ env.VERSION}}.zip
